<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-green-800">ลืมรหัสผ่าน</h3>
        <button onclick="closeForgotPasswordModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Flash Messages -->
      <div id="forgotPasswordMessages">
        <!-- Messages will be shown here -->
      </div>
      
      <!-- Forgot Password Form -->
      <form id="forgotPasswordForm" class="space-y-4">
        <!-- CSRF Protection -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div>
          <label for="forgot_email" class="block text-sm font-medium text-gray-700 mb-1">อีเมล *</label>
          <input id="forgot_email" name="email" type="email" required 
                 class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-green-800 focus:border-green-800 focus:z-10 sm:text-sm"
                 placeholder="กรอกอีเมลที่ใช้ลงทะเบียน"
                 autocomplete="email">
        </div>

        <div class="flex justify-center mt-6">
          <button type="submit" id="forgotPasswordBtn"
                  class="w-48 flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-800 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
            <span id="forgotBtnText">ส่งลิงก์รีเซ็ตรหัสผ่าน</span>
            <span id="forgotBtnLoading" class="hidden flex items-center">
              <svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              กำลังส่ง...
            </span>
          </button>
        </div>
      </form>
      
      <div class="mt-4 text-center">
        <p class="text-sm text-gray-600">
          จำรหัสผ่านได้แล้ว?
          <button onclick="closeForgotPasswordModal(); showLoginModal();" 
                  class="font-medium text-green-800 hover:text-green-700 bg-transparent border-none cursor-pointer">
            เข้าสู่ระบบ
          </button>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-green-800">ตั้งรหัสผ่านใหม่</h3>
        <button onclick="closeResetPasswordModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Flash Messages -->
      <div id="resetPasswordMessages">
        <!-- Messages will be shown here -->
      </div>
      
      <!-- Reset Password Form -->
      <form id="resetPasswordForm" class="space-y-4">
        <!-- CSRF Protection -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="token" id="resetToken">
        
        <div>
          <label for="reset_new_password" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่านใหม่ *</label>
          <input id="reset_new_password" name="new_password" type="password" required 
                 class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-green-800 focus:border-green-800 focus:z-10 sm:text-sm"
                 placeholder="กรอกรหัสผ่านใหม่ (อย่างน้อย 6 ตัวอักษร)"
                 minlength="6">
        </div>

        <div>
          <label for="reset_confirm_password" class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่านใหม่ *</label>
          <input id="reset_confirm_password" name="confirm_password" type="password" required 
                 class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-green-800 focus:border-green-800 focus:z-10 sm:text-sm"
                 placeholder="กรอกรหัสผ่านใหม่อีกครั้ง"
                 minlength="6">
        </div>

        <div class="flex justify-center mt-6">
          <button type="submit" id="resetPasswordBtn"
                  class="w-48 flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-800 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
            <span id="resetBtnText">ตั้งรหัสผ่านใหม่</span>
            <span id="resetBtnLoading" class="hidden flex items-center">
              <svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              กำลังตั้งรหัสผ่าน...
            </span>
          </button>
        </div>
      </form>
      
      <div class="mt-4 text-center">
        <p class="text-sm text-gray-600">
          <button onclick="closeResetPasswordModal(); showLoginModal();" 
                  class="font-medium text-green-800 hover:text-green-700 bg-transparent border-none cursor-pointer">
            กลับไปหน้าเข้าสู่ระบบ
          </button>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// ฟังก์ชันแสดง/ซ่อน Modal
function showForgotPasswordModal() {
    closeLoginModal();
    document.getElementById('forgotPasswordModal').classList.remove('hidden');
    document.getElementById('forgotPasswordMessages').innerHTML = '';
    document.getElementById('forgotPasswordForm').reset();
}

function closeForgotPasswordModal() {
    document.getElementById('forgotPasswordModal').classList.add('hidden');
}

function showResetPasswordModal(token) {
    closeForgotPasswordModal();
    document.getElementById('resetToken').value = token;
    document.getElementById('resetPasswordModal').classList.remove('hidden');
    document.getElementById('resetPasswordMessages').innerHTML = '';
    document.getElementById('resetPasswordForm').reset();
}

function closeResetPasswordModal() {
    document.getElementById('resetPasswordModal').classList.add('hidden');
}

// จัดการการส่งฟอร์มลืมรหัสผ่าน
document.addEventListener('DOMContentLoaded', function() {
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
    const forgotBtnText = document.getElementById('forgotBtnText');
    const forgotBtnLoading = document.getElementById('forgotBtnLoading');
    const messagesDiv = document.getElementById('forgotPasswordMessages');

    forgotPasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('forgot_email').value.trim();
        
        if (!email) {
            showMessage('กรุณากรอกอีเมล', 'error');
            return;
        }

        // ป้องกันการกดซ้ำ
        forgotPasswordBtn.disabled = true;
        forgotBtnText.classList.add('hidden');
        forgotBtnLoading.classList.remove('hidden');

        // ส่งคำขอรีเซ็ตรหัสผ่าน
        fetch('{{ url_for("auth.forgot_password") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: `email=${encodeURIComponent(email)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                // ซ่อนฟอร์มหลังจากสำเร็จ
                document.getElementById('forgotPasswordForm').style.display = 'none';
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'error');
        })
        .finally(() => {
            // คืนสถานะปุ่ม
            forgotPasswordBtn.disabled = false;
            forgotBtnText.classList.remove('hidden');
            forgotBtnLoading.classList.add('hidden');
        });
    });

    function showMessage(message, type) {
        const alertClass = type === 'error' 
            ? 'bg-red-100 border border-red-300 text-red-700' 
            : 'bg-green-100 border border-green-300 text-green-700';
        
        messagesDiv.innerHTML = `
            <div class="rounded-md p-4 mb-4 ${alertClass} text-sm">
                ${message}
            </div>
        `;
    }
});

// จัดการการส่งฟอร์มรีเซ็ตรหัสผ่าน
document.addEventListener('DOMContentLoaded', function() {
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const resetBtnText = document.getElementById('resetBtnText');
    const resetBtnLoading = document.getElementById('resetBtnLoading');
    const messagesDiv = document.getElementById('resetPasswordMessages');

    resetPasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('reset_new_password').value;
        const confirmPassword = document.getElementById('reset_confirm_password').value;
        const token = document.getElementById('resetToken').value;
        
        // Debug: แสดงค่าที่ได้
        console.log('New Password:', newPassword);
        console.log('Confirm Password:', confirmPassword);
        console.log('Token:', token);
        console.log('New Password Length:', newPassword ? newPassword.length : 0);
        console.log('Confirm Password Length:', confirmPassword ? confirmPassword.length : 0);
        
        // ตรวจสอบข้อมูล
        if (!newPassword || newPassword.trim().length === 0) {
            showResetMessage('กรุณากรอกรหัสผ่านใหม่', 'error');
            return;
        }
        
        if (!confirmPassword || confirmPassword.trim().length === 0) {
            showResetMessage('กรุณายืนยันรหัสผ่านใหม่', 'error');
            return;
        }
        
        // ตรวจสอบเพิ่มเติม
        if (newPassword === '' || confirmPassword === '') {
            showResetMessage('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
            return;
        }
        
        // ตรวจสอบความยาวรหัสผ่าน
        if (newPassword.trim().length < 6) {
            showResetMessage('รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร', 'error');
            return;
        }
        
        if (newPassword.trim() !== confirmPassword.trim()) {
            showResetMessage('รหัสผ่านใหม่ไม่ตรงกัน', 'error');
            return;
        }

        // ป้องกันการกดซ้ำ
        resetPasswordBtn.disabled = true;
        resetBtnText.classList.add('hidden');
        resetBtnLoading.classList.remove('hidden');

        // ส่งคำขอรีเซ็ตรหัสผ่าน
        fetch(`/reset-password/${token}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: `new_password=${encodeURIComponent(newPassword)}&confirm_password=${encodeURIComponent(confirmPassword)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showResetMessage(data.message, 'success');
                // หลังจากสำเร็จ ให้เด้งไปหน้า login modal
                setTimeout(() => {
                    closeResetPasswordModal();
                    showLoginModal();
                }, 2000);
            } else {
                showResetMessage(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showResetMessage('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'error');
        })
        .finally(() => {
            // คืนสถานะปุ่ม
            resetPasswordBtn.disabled = false;
            resetBtnText.classList.remove('hidden');
            resetBtnLoading.classList.add('hidden');
        });
    });

    function showResetMessage(message, type) {
        const alertClass = type === 'error' 
            ? 'bg-red-100 border border-red-300 text-red-700' 
            : 'bg-green-100 border border-green-300 text-green-700';
        
        messagesDiv.innerHTML = `
            <div class="rounded-md p-4 mb-4 ${alertClass} text-sm">
                ${message}
            </div>
        `;
    }
});

// ตรวจสอบว่ารหัสผ่านตรงกันหรือไม่
document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('reset_new_password');
    const confirmPassword = document.getElementById('reset_confirm_password');
    
    if (newPassword && confirmPassword) {
        confirmPassword.addEventListener('input', function() {
            if (newPassword.value !== this.value) {
                this.setCustomValidity('รหัสผ่านไม่ตรงกัน');
            } else {
                this.setCustomValidity('');
            }
        });

        newPassword.addEventListener('input', function() {
            if (confirmPassword.value) {
                if (this.value !== confirmPassword.value) {
                    confirmPassword.setCustomValidity('รหัสผ่านไม่ตรงกัน');
                } else {
                    confirmPassword.setCustomValidity('');
                }
            }
        });
    }
});
</script>
