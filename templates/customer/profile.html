

{% extends "customer/layout.html" %}

{% block title %}โปรไฟล์ - TireWeb{% endblock %}

{% block content %}


<!-- Page Header -->
<h1 class="text-2xl font-bold mb-4" style="color: #0c5e28;">โปรไฟล์ของฉัน</h1>
<nav class="text-green-800 text-base mb-2 flex items-center flex-wrap" aria-label="Breadcrumb">
  <a href="/" class="font-bold text-[#0c5e28] hover:underline">หน้าแรก</a>
  <span class="mx-2">›</span>
  <span class="text-black text-sm text-green-800 max-w-xs truncate">โปรไฟล์ของฉัน</span>
</nav>

<!-- Profile Content -->
<div class="max-w-2xl mx-auto px-6 md:px-12 lg:px-16 xl:px-20">
    <div class="bg-white rounded-xl shadow-sm border p-6 md:p-8">
        <form method="POST" action="{{ url_for('customer.profile') }}" id="profile-form">
            <!-- CSRF Protection -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!-- Avatar Section -->
        <div class="mb-8">
            <h2 class="block text-sm font-medium text-gray-700 mb-4">
                รูปโปรไฟล์
            </h2>
            <div class="flex flex-col items-center space-y-4">
                {% if session.get('customer_avatar') %}
                    <img id="profile-avatar"
                         src="{{ url_for('uploaded_file', filename=session.get('customer_avatar')) }}?v={{ range(1, 10000) | random }}"
                         alt="Profile Avatar"
                         class="w-32 h-32 rounded-full object-cover border-4 border-green-200 shadow-lg"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-32 h-32 rounded-full bg-green-200 flex items-center justify-center text-green-900 text-4xl font-bold shadow-lg" style="display: none;">
                        {{ user.username[:1]|upper if user.username else 'U' }}
                    </div>
                {% else %}
                    <div class="w-32 h-32 rounded-full bg-green-200 flex items-center justify-center text-green-900 text-4xl font-bold shadow-lg">
                        {{ user.username[:1]|upper if user.username else 'U' }}
                    </div>
                {% endif %}
                <div class="text-center">
                                    <div id="avatar-upload-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id="avatar-csrf-token">
                        <label for="avatar-input" class="cursor-pointer inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            แก้ไขภาพโปรไฟล์
                        </label>
                        <input type="file" 
                               id="avatar-input" 
                               name="avatar" 
                               accept="image/*"
                               class="hidden">
                        <p class="text-xs text-gray-500 mt-2">รองรับไฟล์ JPG, PNG ขนาดไม่เกิน 5MB</p>
                    </form>
                    <div id="message-box" class="hidden p-3 rounded-lg text-sm font-medium mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Personal Information -->
        <div class="space-y-6">
            
            
            <!-- Username (Read-only) -->
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 mb-2 mt-4">
                    ชื่อผู้ใช้ (Username)
                </label>
                <input type="text" 
                       id="username" 
                       value="{{ user.username or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                       readonly>
                <p class="text-sm text-gray-500 mt-1">ไม่สามารถแก้ไขชื่อผู้ใช้ได้</p>
            </div>

            <!-- Name -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                    ชื่อ-นามสกุล
                </label>
                <input type="text" 
                       id="name" 
                       name="name"
                       value="{{ user.name if user and user.name else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="กรอกชื่อ-นามสกุล">

            </div>



            <!-- Phone -->
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                    เบอร์โทรศัพท์
                </label>
                <input type="tel" 
                       id="phone" 
                       name="phone"
                       value="{{ user.phone if user and user.phone else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="กรอกเบอร์โทรศัพท์">

            </div>

            <!-- Email -->
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                    อีเมล
                </label>
                <input type="text" 
                       id="email" 
                       value="{{ user.email or 'ไม่ระบุ' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                       readonly>
            </div>

            <!-- Created Date (Read-only) -->
            <div>
                <label for="created_at" class="block text-sm font-medium text-gray-700 mb-2">
                    วันที่สร้างบัญชี
                </label>
                <input type="text" 
                       id="created_at" 
                       value="{{ user.created_at or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                       readonly>
            </div>

            <!-- Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{{ url_for('customer.home') }}" 
                   class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ยกเลิก
                </a>
                <button type="button" 
                        id="save-profile-btn"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    บันทึกข้อมูล
                </button>

            </div>
        </form>
    </div>
</div>

<script>
    // Simple, direct save button handler
    document.addEventListener('DOMContentLoaded', function() {
        const saveBtn = document.getElementById('save-profile-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get form data
                const form = document.getElementById('profile-form');
                if (form) {
                    form.submit();
                }
            });
        }
    });
    
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const messageBox = document.getElementById('message-box');
            
            // แสดงข้อความ
            function showMessage(msg, type) {
                messageBox.textContent = msg;
                messageBox.className = 'p-3 my-2 rounded-lg';
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                }
                messageBox.classList.remove('hidden');
            }

            // ตรวจสอบประเภทไฟล์
            if (!file.type.startsWith('image/')) {
                showMessage('กรุณาเลือกไฟล์ภาพเท่านั้น', 'error');
                input.value = '';
                return;
            }
            
            // ตรวจสอบขนาดไฟล์ (ไม่เกิน 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showMessage('ขนาดไฟล์ต้องไม่เกิน 5MB', 'error');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                // หา element ที่แสดงรูปภาพ
                const avatarContainer = document.querySelector('.flex.flex-col.items-center.space-y-4');
                const existingImg = avatarContainer.querySelector('img');
                const existingDiv = avatarContainer.querySelector('div.w-32.h-32.rounded-full.bg-green-200');
                
                // สร้างรูปภาพใหม่
                const newImg = document.createElement('img');
                newImg.src = e.target.result;
                newImg.alt = 'Profile Avatar Preview';
                newImg.className = 'w-32 h-32 rounded-full object-cover border-4 border-green-200 shadow-lg';
                
                // ลบรูปภาพเก่าหรือ div เก่า
                if (existingImg) {
                    existingImg.remove();
                }
                if (existingDiv) {
                    existingDiv.remove();
                }
                
                // เพิ่มรูปภาพใหม่
                avatarContainer.insertBefore(newImg, avatarContainer.firstChild);
            };
            
            reader.readAsDataURL(input.files[0]);
            
            // ดึง CSRF token ใหม่ก่อนส่ง
            fetch('/get-csrf-token')
                .then(response => response.json())
                .then(tokenData => {
                    // อัปเดต CSRF token
                    document.getElementById('avatar-csrf-token').value = tokenData.csrf_token;
                    
                    // ส่งฟอร์มอัปโหลดรูปอัตโนมัติ
                    const avatarForm = document.getElementById('avatar-upload-form');
                    if (avatarForm) {
                        // สร้าง FormData และส่งด้วย fetch เพื่อไม่ให้หน้าโหลดใหม่
                        const formData = new FormData();
                        
                        // เพิ่มไฟล์รูปภาพ
                        const fileInput = document.getElementById('avatar-input');
                        if (fileInput.files[0]) {
                            formData.append('avatar', fileInput.files[0]);
                        }
                        
                        // ใช้ CSRF token ใหม่
                        formData.append('csrf_token', tokenData.csrf_token);
                        
                        return fetch('/update-avatar', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // แสดงข้อความสำเร็จ
                        const messageBox = document.getElementById('message-box');
                        if (messageBox) {
                            messageBox.textContent = 'อัปเดตรูปโปรไฟล์สำเร็จ';
                            messageBox.className = 'p-3 my-2 rounded-lg bg-green-100 text-green-700';
                            messageBox.classList.remove('hidden');
                            
                            // ซ่อนข้อความหลังจาก 3 วินาที
                            setTimeout(() => {
                                messageBox.classList.add('hidden');
                            }, 3000);
                        }
                        
                        // อัปเดตรูปภาพทันทีโดยไม่ต้องรอ
                        const newFilename = data.filename || '{{ user.avatar_filename if user.avatar_filename else "" }}';
                        const timestamp = new Date().getTime();
                        
                        console.log('Updating avatar with filename:', newFilename);
                            
                            // อัปเดต src ของรูปภาพด้วย cache busting
                            const avatarImg = document.querySelector('#profile-avatar');
                            if (avatarImg && newFilename) {
                                avatarImg.src = `/static/uploads/profile/${newFilename}?v=${timestamp}`;
                            }
                            
                            // อัปเดตรูปภาพใน header ด้วย
                            console.log('Updating header avatar...');
                            const headerAvatar = document.querySelector('#header-avatar');
                            if (headerAvatar && newFilename) {
                                headerAvatar.src = `/static/uploads/profile/${newFilename}?v=${timestamp}`;
                                console.log('Updated existing header avatar');
                            } else if (newFilename) {
                                // ถ้าไม่มี header-avatar ให้สร้างใหม่
                                console.log('Creating new header avatar...');
                                const profileMenuButton = document.querySelector('#profileMenuButton');
                                if (profileMenuButton) {
                                    // ลบ element เก่าทั้งหมด
                                    profileMenuButton.innerHTML = '';
                                    
                                    // สร้าง img ใหม่
                                    const newHeaderImg = document.createElement('img');
                                    newHeaderImg.id = 'header-avatar';
                                    newHeaderImg.src = `/static/uploads/profile/${newFilename}?v=${timestamp}`;
                                    newHeaderImg.alt = 'โปรไฟล์';
                                    newHeaderImg.className = 'w-10 h-10 rounded-full border-2 border-white object-cover';
                                    newHeaderImg.onerror = function() {
                                        this.style.display = 'none';
                                        this.nextElementSibling.style.display = 'flex';
                                    };
                                    
                                    // สร้าง div fallback
                                    const fallbackDiv = document.createElement('div');
                                    fallbackDiv.className = 'w-10 h-10 rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold border-2 border-white';
                                    fallbackDiv.style.display = 'none';
                                    fallbackDiv.textContent = '{{ session.get("customer_username","U")[0]|upper }}';
                                    
                                    // เพิ่ม elements
                                    profileMenuButton.appendChild(newHeaderImg);
                                    profileMenuButton.appendChild(fallbackDiv);
                                    
                                    console.log('Created new header avatar with filename:', newFilename);
                                }
                            }
                            
                            // อัปเดต session ในหน้าโปรไฟล์ (สำหรับการแสดงผลทันที)
                            if (newFilename) {
                                // สร้างรูปภาพใหม่ในหน้าโปรไฟล์
                                const avatarContainer = document.querySelector('.flex.flex-col.items-center.space-y-4');
                                const existingImg = avatarContainer.querySelector('img');
                                const existingDiv = avatarContainer.querySelector('div.w-32.h-32.rounded-full.bg-green-200');
                                
                                // ลบรูปเก่า
                                if (existingImg) {
                                    existingImg.remove();
                                }
                                if (existingDiv) {
                                    existingDiv.remove();
                                }
                                
                                // สร้างรูปใหม่
                                const newImg = document.createElement('img');
                                newImg.id = 'profile-avatar';
                                newImg.src = `/static/uploads/profile/${newFilename}?v=${timestamp}`;
                                newImg.alt = 'Profile Avatar';
                                newImg.className = 'w-32 h-32 rounded-full object-cover border-4 border-green-200 shadow-lg';
                                newImg.onerror = function() {
                                    this.style.display = 'none';
                                    this.nextElementSibling.style.display = 'flex';
                                };
                                
                                // เพิ่มรูปใหม่
                                avatarContainer.insertBefore(newImg, avatarContainer.firstChild);
                            }
                            
                            // อัปเดตรูปใน header ทันที
                            console.log('Calling updateHeaderAvatar function...');
                            if (typeof updateHeaderAvatar === 'function') {
                                updateHeaderAvatar();
                            } else {
                                console.log('updateHeaderAvatar function not found');
                            }
                            
                            // อัปเดตรูปใน header ทันทีอีกครั้ง
                            setTimeout(() => {
                                console.log('Calling updateHeaderAvatar function after timeout...');
                                if (typeof updateHeaderAvatar === 'function') {
                                    updateHeaderAvatar();
                                } else {
                                    console.log('updateHeaderAvatar function not found after timeout');
                                }
                            }, 500);
                            
                            
                            
                            
                            
                    } else {
                        throw new Error(data.message || 'Upload failed');
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    const messageBox = document.getElementById('message-box');
                    if (messageBox) {
                        // ตรวจสอบว่าเป็น CSRF error หรือไม่
                        if (error.message && error.message.includes('CSRF')) {
                            messageBox.textContent = 'กรุณาโหลดหน้าใหม่แล้วลองอีกครั้ง (CSRF token หมดอายุ)';
                        } else {
                            messageBox.textContent = 'เกิดข้อผิดพลาดในการอัปโหลดรูป: ' + error.message;
                        }
                        messageBox.className = 'p-3 my-2 rounded-lg bg-red-100 text-red-700';
                        messageBox.classList.remove('hidden');
                        
                        // ซ่อนข้อความหลังจาก 5 วินาที
                        setTimeout(() => {
                            messageBox.classList.add('hidden');
                        }, 5000);
                    }
                });
        }
    }

    // อัปเดตภาพใหม่หลังอัปโหลด
    document.addEventListener('DOMContentLoaded', function() {
        // Refresh CSRF token เมื่อโหลดหน้า
        fetch('/get-csrf-token')
            .then(response => response.json())
            .then(data => {
                document.getElementById('avatar-csrf-token').value = data.csrf_token;
            })
            .catch(error => {
                console.error('Error refreshing CSRF token:', error);
            });
        
        const urlParams = new URLSearchParams(window.location.search);
        const avatarUpdated = urlParams.get('avatar_updated');
        const newFilename = urlParams.get('filename');
        const avatarContainer = document.querySelector('.flex.flex-col.items-center.space-y-4');
        const existingImg = avatarContainer.querySelector('img');
        const existingDiv = avatarContainer.querySelector('div.w-32.h-32.rounded-full.bg-green-200');

        if (avatarUpdated === '1' && newFilename) {
            // สร้างรูปภาพใหม่
            const newImg = document.createElement('img');
            newImg.src = `/static/uploads/profile/${newFilename}?t=${new Date().getTime()}`;
            newImg.alt = 'Profile Avatar';
            newImg.className = 'w-32 h-32 rounded-full object-cover border-4 border-green-200 shadow-lg';
            
            // ลบรูปภาพเก่าหรือ div เก่า
            if (existingImg) {
                existingImg.remove();
            }
            if (existingDiv) {
                existingDiv.remove();
            }
            
            // เพิ่มรูปภาพใหม่
            avatarContainer.insertBefore(newImg, avatarContainer.firstChild);
            
                            // อัปเดตรูปใน header ทันที
                            console.log('Calling updateHeaderAvatar function...');
                            if (typeof updateHeaderAvatar === 'function') {
                                updateHeaderAvatar();
                            } else {
                                console.log('updateHeaderAvatar function not found');
                            }
                            
                            // อัปเดตรูปใน header ทันทีอีกครั้ง
                            setTimeout(() => {
                                console.log('Calling updateHeaderAvatar function after timeout...');
                                if (typeof updateHeaderAvatar === 'function') {
                                    updateHeaderAvatar();
                                } else {
                                    console.log('updateHeaderAvatar function not found after timeout');
                                }
                            }, 500);
                            
                            
                            
                            
                            
            
            // ลบพารามิเตอร์ออกจาก URL
            history.replaceState({}, document.title, window.location.pathname);
        }
        
        // อัปเดตรูปใน header เมื่อโหลดหน้า
        if (typeof updateHeaderAvatar === 'function') {
            updateHeaderAvatar();
        }
        
        // Set up avatar upload handling
        const avatarInput = document.getElementById('avatar-input');
        if (avatarInput) {
            avatarInput.addEventListener('change', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Call previewImage function
                previewImage(this);
            });
        }
        
        // Refresh CSRF token ทุก 5 นาที
        setInterval(() => {
            fetch('/get-csrf-token')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('avatar-csrf-token').value = data.csrf_token;
                    console.log('CSRF token refreshed');
                })
                .catch(error => {
                    console.error('Error refreshing CSRF token:', error);
                });
        }, 5 * 60 * 1000); // 5 นาที
    });
</script>
{% endblock %}