{% extends 'staff/layout.html' %}
{% block title %}{% if booking %}แก้ไขการจอง{% else %}เพิ่มการจอง{% endif %}{% endblock %}
{% block extra_head %}
<script src="{{ url_for('static', filename='booking_form.js') }}"></script>
<style>
.tab-nav {
  display: flex;
  border-bottom: 2px solid #e5e7eb;
  margin-bottom: 1.5rem;
}
.tab-button {
  flex: 1;
  padding: 12px 16px;
  text-align: center;
  background: none;
  border: none;
  cursor: pointer;
  font-weight: 500;
  color: #6b7280;
  position: relative;
  transition: all 0.3s ease;
}
.tab-button:hover {
  color: #0c5e28;
}
.tab-button.active {
  color: #0c5e28;
  font-weight: 600;
}
.tab-button.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 3px;
  background-color: #0c5e28;
  border-radius: 2px;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
</style>
{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-4">
  <h1 class="text-2xl font-bold mb-4" style="color: #0c5e28;">
    {% if booking %}แก้ไขข้อมูลการจอง{% else %}เพิ่มการจอง{% endif %}
  </h1>

  <div class="bg-white rounded-lg shadow-md p-6">
    <form method="post" class="space-y-4">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <!-- Tab Navigation -->
      <div class="tab-nav" style="display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem;">
        <button type="button" class="tab-button active" onclick="showTab('vehicle')" onmouseover="this.style.color='#0c5e28'" onmouseout="this.style.color='#0c5e28'" style="flex: 1; padding: 12px 16px; text-align: center; background: none; border: none; cursor: pointer; font-weight: 600; color: #0c5e28; position: relative; transition: all 0.3s ease; border-bottom: 3px solid #0c5e28;">ข้อมูลรถ</button>
        <button type="button" class="tab-button" onclick="showTab('customer')" onmouseover="this.style.color='#0c5e28'" onmouseout="if(!this.classList.contains('active')) this.style.color='#6b7280'" style="flex: 1; padding: 12px 16px; text-align: center; background: none; border: none; cursor: pointer; font-weight: 500; color: #6b7280; position: relative; transition: all 0.3s ease;">ข้อมูลลูกค้า</button>
        <button type="button" class="tab-button" onclick="showTab('booking')" onmouseover="this.style.color='#0c5e28'" onmouseout="if(!this.classList.contains('active')) this.style.color='#6b7280'" style="flex: 1; padding: 12px 16px; text-align: center; background: none; border: none; cursor: pointer; font-weight: 500; color: #6b7280; position: relative; transition: all 0.3s ease;">ข้อมูลการจอง</button>
        <button type="button" class="tab-button" onclick="showTab('services')" onmouseover="this.style.color='#0c5e28'" onmouseout="if(!this.classList.contains('active')) this.style.color='#6b7280'" style="flex: 1; padding: 12px 16px; text-align: center; background: none; border: none; cursor: pointer; font-weight: 500; color: #6b7280; position: relative; transition: all 0.3s ease;">บริการที่ต้องการ</button>
      </div>
      
      <!-- Tab Content -->
      <!-- ข้อมูลรถ -->
      <div id="vehicle" class="tab-content active mb-8">
        <h3 class="text-lg font-semibold mb-4" style="color: #0c5e28; background-color: #0c5e28; color: white; padding: 8px 12px; border-radius: 4px;">ข้อมูลรถ</h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
          <!-- ประเภทรถ -->
          <div class="col-span-full">
            <label class="block text-sm font-medium text-green-800 mb-2">ประเภทรถ <span class="text-red-600">*</span></label>
            <div class="flex flex-col sm:flex-row sm:flex-wrap gap-2 sm:gap-4">
              {% for vt in vehicle_types %}
              <label class="inline-flex items-center">
                <input type="radio" name="vehicle_type_id" value="{{ vt.vehicle_type_id }}" 
                       {% if booking and booking.vehicle_type_id == vt.vehicle_type_id %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">{{ vt.vehicle_type_name }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          
          <!-- ระบบรถ -->
          <div class="col-span-full">
            <label class="block text-sm font-medium text-green-800 mb-2">ระบบรถ</label>
            <div class="flex flex-col sm:flex-row sm:flex-wrap gap-2 sm:gap-4">
              <label class="inline-flex items-center">
                <input type="radio" name="engine_type" value="เบนซิน" 
                       {% if booking and booking.engine_type_name == 'เบนซิน' %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">เบนซิน</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="engine_type" value="ดีเซล" 
                       {% if booking and booking.engine_type_name == 'ดีเซล' %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">ดีเซล</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="engine_type" value="ไฮบริด" 
                       {% if booking and booking.engine_type_name == 'ไฮบริด' %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">ไฮบริด</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="engine_type" value="ไฟฟ้า (EV)" 
                       {% if booking and booking.engine_type_name == 'ไฟฟ้า (EV)' %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">ไฟฟ้า (EV)</span>
              </label>
            </div>
          </div>
          
          <!-- ทะเบียนรถ/จังหวัด/ยี่ห้อรถ -->
          <div class="col-span-full">
            <!-- Input fields ในบรรทัดเดียวกัน -->
            <div class="flex flex-col md:flex-row gap-4 mt-3">
              <!-- ทะเบียนรถ -->
              <div class="flex-1">
                <label for="license_plate" class="block mb-1 text-sm font-medium text-green-800">
                  ทะเบียนรถ (เช่น บษ 9990)
                </label>
                <input type="text" id="license_plate" name="license_plate" 
                       value="{{ booking.license_plate if booking and booking.license_plate and booking.license_plate != 'None' else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
              </div>
              
              <!-- จังหวัด -->
              <div class="flex-1">
                <label for="license_province" class="block mb-1 text-sm font-medium text-green-800">
                  จังหวัด
                </label>
                <select id="license_province" name="license_province" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                  <option value="">-- เลือกจังหวัด --</option>
                  {% for p in provinces %}
                  <option value="{{ p }}" {% if booking and booking.license_province == p %}selected{% endif %}>{{ p }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- ยี่ห้อรถ -->
              <div class="flex-1">
                <label for="brand_id" class="block mb-1 text-sm font-medium text-green-800">
                  ยี่ห้อรถ
                </label>
                <select id="brand_id" name="brand_id" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                  <option value="">-- เลือกยี่ห้อ --</option>
                  {% for brand in vehicle_brands %}
                  <option value="{{ brand.car_brand_name }}" 
                          {% if booking and booking.brand_name == brand.car_brand_name %}selected{% endif %}>
                    {{ brand.car_brand_name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          
          <!-- รุ่น -->
          <div>
            <label for="model_name" class="block text-sm font-medium text-green-800 mb-1">รุ่น</label>
            <select id="model_name" name="model_name" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
              <option value="">-- เลือกรุ่น --</option>
              {% for model in vehicle_models %}
              <option value="{{ model.model_name }}" 
                      {% if booking and booking.model_name == model.model_name %}selected{% endif %}>
                {{ model.model_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          
          <!-- สี -->
          <div>
            <label for="color" class="block text-sm font-medium text-green-800 mb-1">สี</label>
            <input type="text" id="color" name="color" 
                   value="{{ booking.color if booking and booking.color and booking.color != 'None' else '' }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          
          <!-- ปีที่ผลิต -->
          <div>
            <label for="production_year" class="block text-sm font-medium text-green-800 mb-1">ปีที่ผลิต</label>
            <input type="number" id="production_year" name="production_year" min="1900" max="2030"
                   value="{{ booking.production_year if booking and booking.production_year and booking.production_year != 'None' else '' }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
        </div>
      </div>
      
      <!-- ข้อมูลลูกค้า -->
      <div id="customer" class="tab-content mb-8">
        <h3 class="text-lg font-semibold mb-4" style="color: #0c5e28; background-color: #0c5e28; color: white; padding: 8px 12px; border-radius: 4px;">ข้อมูลลูกค้า</h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
          <!-- เพศ -->
          <div class="col-span-full">
            <label class="block text-sm font-medium text-green-800 mb-2">เพศ</label>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
              <label class="inline-flex items-center">
                <input type="radio" name="gender" value="ชาย" 
                       {% if booking and booking.gender == 'ชาย' %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">ชาย</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="gender" value="หญิง" 
                       {% if booking and booking.gender == 'หญิง' %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">หญิง</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="gender" value="ไม่ระบุ" 
                       {% if booking and booking.gender == 'ไม่ระบุ' %}checked{% endif %}
                       class="mr-2">
                <span class="text-sm">ไม่ระบุ</span>
              </label>
            </div>
          </div>
          
          <!-- ชื่อ-นามสกุล -->
          <div>
            <label for="first_name" class="block text-sm font-medium text-green-800 mb-1">ชื่อ <span class="text-red-600">*</span></label>
            <input type="text" id="first_name" name="first_name"
                   value="{{ booking.first_name if booking and booking.first_name and booking.first_name != 'None' else '' }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          
          <div>
            <label for="last_name" class="block text-sm font-medium text-green-800 mb-1">นามสกุล <span class="text-red-600">*</span></label>
            <input type="text" id="last_name" name="last_name"
                   value="{{ booking.last_name if booking and booking.last_name and booking.last_name != 'None' else '' }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          
          <!-- วันเกิด -->
          <div>
            <label for="birthdate" class="block text-sm font-medium text-green-800 mb-1">วันเกิด</label>
            <input type="date" id="birthdate" name="birthdate"
                   value="{% if booking and booking.birthdate %}{{ booking.birthdate.strftime('%Y-%m-%d') if booking.birthdate.strftime else booking.birthdate }}{% else %}{% endif %}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          
          <!-- เบอร์โทรศัพท์ -->
          <div>
            <label for="phone" class="block text-sm font-medium text-green-800 mb-1">เบอร์โทรศัพท์ <span class="text-red-600">*</span></label>
            <input type="tel" id="phone" name="phone"
                   value="{{ booking.phone if booking and booking.phone and booking.phone != 'None' else '' }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          
          <!-- อีเมล -->
          <div>
            <label for="email" class="block text-sm font-medium text-green-800 mb-1">อีเมล</label>
            <input type="email" id="email" name="email"
                   value="{{ booking.email if booking and booking.email and booking.email != 'None' else '' }}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          
          <!-- ที่อยู่ -->
          <div class="col-span-full mt-4">
            <h4 class="text-md font-bold text-green-900 mb-3">ที่อยู่</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
              <div>
                <label for="address_no" class="block text-sm font-medium text-green-800 mb-1">เลขที่</label>
                <input type="text" id="address_no" name="address_no"
                       value="{{ booking.address_no if booking and booking.address_no and booking.address_no != 'None' else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
              </div>
              
              <div>
                <label for="village" class="block text-sm font-medium text-green-800 mb-1">หมู่</label>
                <input type="text" id="village" name="village"
                       value="{{ booking.village if booking and booking.village and booking.village != 'None' else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
              </div>
              
              <div>
                <label for="road" class="block text-sm font-medium text-green-800 mb-1">ถนน</label>
                <input type="text" id="road" name="road"
                       value="{{ booking.road if booking and booking.road and booking.road != 'None' else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
              </div>
              
              <div>
                <label for="district" class="block text-sm font-medium text-green-800 mb-1">อำเภอ/เขต</label>
                <select id="district" name="district" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                  <option value="">-- เลือกอำเภอ/เขต --</option>
                  {% if booking and booking.district and booking.district != 'None' %}
                  <option value="{{ booking.district }}" selected>{{ booking.district }}</option>
                  {% endif %}
                </select>
              </div>
              
              <div>
                <label for="subdistrict" class="block text-sm font-medium text-green-800 mb-1">ตำบล/แขวง</label>
                <select id="subdistrict" name="subdistrict" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                  <option value="">-- เลือกตำบล/แขวง --</option>
                  {% if booking and booking.subdistrict and booking.subdistrict != 'None' %}
                  <option value="{{ booking.subdistrict }}" selected>{{ booking.subdistrict }}</option>
                  {% endif %}
                </select>
              </div>
              
              <div>
                <label for="province" class="block text-sm font-medium text-green-800 mb-1">จังหวัด</label>
                <select id="province" name="province" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                  <option value="">-- เลือกจังหวัด --</option>
                  {% for p in provinces %}
                  <option value="{{ p }}" {% if booking and booking.province == p %}selected{% endif %}>{{ p }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div>
                <label for="zipcode" class="block text-sm font-medium text-green-800 mb-1">รหัสไปรษณีย์</label>
                <input type="text" id="zipcode" name="zipcode"
                       value="{{ booking.zipcode if booking and booking.zipcode and booking.zipcode != 'None' else '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ข้อมูลการจอง -->
      <div id="booking" class="tab-content mb-8">
        <h3 class="text-lg font-semibold mb-4" style="color: #0c5e28; background-color: #0c5e28; color: white; padding: 8px 12px; border-radius: 4px;">ข้อมูลการจอง</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- วันที่เข้าใช้บริการ -->
          <div>
            <label class="block text-sm font-medium text-green-800 mb-1">วันที่เข้าใช้บริการ <span class="text-red-600">*</span></label>
            <input type="date" name="service_date" 
                   value="{% if booking and booking.service_date %}{{ booking.service_date.strftime('%Y-%m-%d') if booking.service_date.strftime else booking.service_date }}{% else %}{% endif %}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          
          <!-- เวลาเข้ารับบริการ -->
          <div>
            <label class="block text-sm font-medium text-green-800 mb-1">เวลาเข้ารับบริการ <span class="text-red-600">*</span></label>
            <input type="time" name="service_time" 
                   value="{% if booking and booking.service_time %}{{ '%02d:%02d'|format(booking.service_time.seconds // 3600, (booking.service_time.seconds % 3600) // 60) if booking.service_time.seconds else booking.service_time.strftime('%H:%M') if booking.service_time.strftime else '' }}{% else %}{% endif %}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
        </div>
        
        <!-- สถานะ -->
        <div class="mt-4">
          <label class="block text-sm font-medium text-green-800 mb-1">สถานะ <span class="text-red-600">*</span></label>
          <select name="status" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="รอดำเนินการ" {% if booking and booking.status=='รอดำเนินการ' %}selected{% endif %}>รอดำเนินการ</option>
            <option value="สำเร็จ" {% if booking and booking.status=='สำเร็จ' %}selected{% endif %}>สำเร็จ</option>
            <option value="ยกเลิก" {% if booking and booking.status=='ยกเลิก' %}selected{% endif %}>ยกเลิก</option>
          </select>
        </div>
        
        <!-- หมายเหตุ -->
        <div class="mt-4">
          <h3 class="text-lg font-semibold mb-4" style="color: #0c5e28; background-color: #0c5e28; color: white; padding: 8px 12px; border-radius: 4px;">หมายเหตุ</h3>
          <textarea id="note" name="note" rows="3" 
                    placeholder="กรุณาระบุรายละเอียดเพิ่มเติม (ถ้ามี)"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">{{ booking.note if booking and booking.note else '' }}</textarea>
        </div>
      </div>



      <!-- บริการที่ต้องการ -->
      <div id="services" class="tab-content mb-8">
        <h3 class="text-lg font-semibold mb-4" style="color: #0c5e28; background-color: #0c5e28; color: white; padding: 8px 12px; border-radius: 4px;">บริการที่ต้องการ</h3>
        <div class="space-y-6">
          {% for category, services in service_groups.items() %}
          <div>
            <div class="font-bold text-green-800 text-lg {% if category == 'ยาง' %}mb-1{% elif category == 'ระบบเบรก' %}mt-6 mb-2{% elif category == 'ไฟฟ้า' %}mt-6 mb-2{% elif category == 'บำรุงรักษา' %}mt-6 mb-2{% elif category == 'ช่วงล่าง' %}mt-6 mb-2{% else %}mb-2{% endif %}">{{ category }}</div>
            {% if category == 'ยาง' %}
            <div>
              <div class="flex flex-col lg:flex-row gap-4 lg:gap-8">
                <!-- ซ้าย: ฟอร์มข้อมูลยางหน้า-หลัง -->
                <div class="flex-1">
                  <!-- ยางด้านหน้า -->
                  <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">ยางด้านหน้า</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-2">
                      <div>
                        <label class="block text-xs font-medium text-green-800">ขนาดยาง</label>
                        <input type="text" name="tire_front_size" class="w-full border rounded px-3 py-2" placeholder=""
                               value="{% if tire_data and tire_data.get('front_left') and tire_data.front_left.size %}{{ tire_data.front_left.size }}{% endif %}">
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-green-800">ยี่ห้อยาง</label>
                        <select name="tire_front_brand_id" id="tire_front_brand" class="w-full border rounded px-3 py-2">
                          <option value="">-- เลือกยี่ห้อ --</option>
                          {% for brand in brands %}
                          <option value="{{ brand.brand_id }}" {% if tire_data and tire_data.get('front_left') and tire_data.front_left.brand_id and tire_data.front_left.brand_id == brand.brand_id %}selected{% endif %}>{{ brand.brand_name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-green-800">รุ่นยาง</label>
                        <select name="tire_front_model_id" id="tire_front_model" class="w-full border rounded px-3 py-2">
                          <option value="">-- เลือกรุ่น --</option>
                          {% if tire_data and tire_data.get('front_left') %}
                          {% for model in tire_models %}
                          <option value="{{ model.model_id }}" {% if tire_data.front_left.model_id and tire_data.front_left.model_id == model.model_id %}selected{% endif %}>
                            {{ model.model_name }}
                          </option>
                          {% endfor %}
                          {% endif %}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ยางด้านหลัง -->
                <div class="flex-1 mb-4">
                  <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold text-gray-800">ยางด้านหลัง</h4>
                    <button type="button" id="copyFrontToRear" 
                            class="text-xs px-3 py-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 hover:border-blue-300 focus:outline-none focus:ring-1 focus:ring-blue-500 border border-blue-300 rounded-md"
                            title="คัดลอกข้อมูลยางหน้าไปยังยางหลัง">
                      คัดลอกจากยางหน้า
                    </button>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-2">
                    <div>
                      <label class="block text-xs font-medium text-green-800">ขนาดยาง</label>
                      <input type="text" name="tire_rear_size" class="w-full border rounded px-3 py-2" placeholder=""
                             value="{% if tire_data and tire_data.get('rear_left') and tire_data.rear_left.size %}{{ tire_data.rear_left.size }}{% endif %}">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-green-800">ยี่ห้อยาง</label>
                      <select name="tire_rear_brand_id" id="tire_rear_brand" class="w-full border rounded px-3 py-2">
                        <option value="">-- เลือกยี่ห้อ --</option>
                        {% for brand in brands %}
                        <option value="{{ brand.brand_id }}" {% if tire_data and tire_data.get('rear_left') and tire_data.rear_left.brand_id and tire_data.rear_left.brand_id == brand.brand_id %}selected{% endif %}>{{ brand.brand_name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-green-800">รุ่นยาง</label>
                      <select name="tire_rear_model_id" id="tire_rear_model" class="w-full border rounded px-3 py-2">
                        <option value="">-- เลือกรุ่น --</option>
                        {% if tire_data and tire_data.get('rear_left') %}
                        {% for model in tire_models %}
                        <option value="{{ model.model_id }}" {% if tire_data.rear_left.model_id and tire_data.rear_left.model_id == model.model_id %}selected{% endif %}>
                          {{ model.model_name }}
                        </option>
                        {% endfor %}
                        {% endif %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ขวา: ฟอร์ม DOT -->
            <div class="mt-4 lg:mt-0">
              <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold text-gray-800">DOT ของยาง</h4>
                <button type="button" id="copyDotToAll" 
                        class="text-xs px-3 py-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 hover:border-blue-300 focus:outline-none focus:ring-1 focus:ring-blue-500 border border-blue-300 rounded-md w-auto"
                        title="คัดลอกข้อมูล DOT จากหน้าซ้ายไปยังส่วนอื่น ๆ">
                  คัดลอกทั้งหมด
                </button>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-green-800">หน้าซ้าย</label>
                  <input type="text" name="dot_front_left" 
                      class="w-full border rounded px-3 py-2 text-center" 
                      placeholder="10/23"
                      value="{% if tire_data and tire_data.get('front_left') and tire_data.front_left.dot %}{{ tire_data.front_left.dot }}{% endif %}">
                </div>
                <div>
                  <label class="block text-xs font-medium text-green-800">หน้าขวา</label>
                  <input type="text" name="dot_front_right" 
                      class="w-full border rounded px-3 py-2 text-center" 
                      placeholder="10/23"
                      value="{% if tire_data and tire_data.get('front_right') and tire_data.front_right.dot %}{{ tire_data.front_right.dot }}{% endif %}">
                </div>
                <div>
                  <label class="block text-xs font-medium text-green-800">หลังซ้าย</label>
                  <input type="text" name="dot_rear_left" 
                      class="w-full border rounded px-3 py-2 text-center" 
                      placeholder="09/23"
                      value="{% if tire_data and tire_data.get('rear_left') and tire_data.rear_left.dot %}{{ tire_data.rear_left.dot }}{% endif %}">
                </div>
                <div>
                  <label class="block text-xs font-medium text-green-800">หลังขวา</label>
                  <input type="text" name="dot_rear_right" 
                      class="w-full border rounded px-3 py-2 text-center" 
                      placeholder="09/23"
                      value="{% if tire_data and tire_data.get('rear_right') and tire_data.rear_right.dot %}{{ tire_data.rear_right.dot }}{% endif %}">
                </div>
              </div>
            </div>
            {% endif %}
            
            <div class="space-y-2">
              {% for s in services %}
              {% if s.service_name == 'เติมลม' %}
              <div>
                <label class="inline-flex items-center gap-2 font-semibold">
                  <input type="checkbox" name="service_id" value="{{ s.service_id }}" 
                         class="w-5 h-5 border-2 border-green-600 text-green-600 focus:ring-green-500"
                         {% if selected_service_ids and s.service_id in selected_service_ids %}checked{% endif %}>
                  {{ s.service_name }}
                </label>
                <div class="ml-8 mt-1 flex flex-row gap-4 flex-wrap">
                  {% for opt in s.options %}
                  <label class="inline-flex items-center gap-2 text-sm font-normal">
                    <input type="checkbox" name="service_option_{{ s.service_id }}" value="{{ opt.option_id }}"
                           class="w-4 h-4 rounded border-gray-400 text-blue-600 focus:ring-blue-500"
                           {% if selected_option_ids and selected_option_ids.get(s.service_id) and (opt.option_id|string) in selected_option_ids.get(s.service_id) %}checked{% endif %}>
                    {{ opt.option_name }}{% if 'ไนโตรเจน' in opt.option_name %} (มีค่าใช้จ่าย){% endif %}
                  </label>
                  {% endfor %}
                </div>
              </div>
              {% elif s.service_name == 'ยางเก่า' %}
              <div>
                <label class="inline-flex items-center gap-2 font-semibold">
                  <input type="checkbox" name="service_id" value="{{ s.service_id }}"
                         class="w-5 h-5 border-2 border-green-600 text-green-600 focus:ring-green-500"
                         {% if selected_service_ids and s.service_id in selected_service_ids %}checked{% endif %}>
                  {{ s.service_name }}
                </label>
                <div class="ml-8 mt-1 flex flex-row gap-4 flex-wrap">
                  {% for opt in s.options %}
                  {% if opt.option_name != 'ไนโตรเจน' %}
                  <label class="inline-flex items-center gap-2 text-sm font-normal">
                    <input type="checkbox" name="service_option_{{ s.service_id }}" value="{{ opt.option_id }}"
                           class="w-4 h-4 rounded border-gray-400 text-blue-600 focus:ring-blue-500"
                           {% if selected_option_ids and selected_option_ids.get(s.service_id) and (opt.option_id|string) in selected_option_ids.get(s.service_id) %}checked{% endif %}>
                    {{ opt.option_name }}
                  </label>
                  {% endif %}
                  {% endfor %}
                </div>
              </div>
              {% else %}
              <div style="margin-top: 8px;">
                <label class="inline-flex items-center gap-2 font-semibold">
                  <input type="checkbox" name="service_id" value="{{ s.service_id }}"
                         class="w-5 h-5 border-2 border-green-600 text-green-600 focus:ring-green-500"
                         {% if selected_service_ids and s.service_id in selected_service_ids %}checked{% endif %}>
                  {{ s.service_name }}
                </label>
                {% if s.options %}
                <div class="ml-8 mt-1 flex flex-row gap-4 flex-wrap">
                  {% for opt in s.options %}
                  <label class="inline-flex items-center gap-2 text-sm font-normal">
                    <input type="checkbox" name="service_option_{{ s.service_id }}" value="{{ opt.option_id }}"
                           class="w-4 h-4 rounded border-gray-400 text-blue-600 focus:ring-blue-500"
                           {% if selected_option_ids and selected_option_ids.get(s.service_id) and (opt.option_id|string) in selected_option_ids.get(s.service_id) %}checked{% endif %}>
                    {{ opt.option_name }}
                  </label>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              {% endif %}
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>



      <!-- ปุ่มส่งฟอร์ม -->
      <div class="mt-8 flex justify-end gap-4">
        <a href="{{ url_for('staff.bookings') }}" 
           class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-200">
          ยกเลิก
        </a>
        <button type="submit" 
                class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
          บันทึกการจอง
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// JavaScript สำหรับ Tab Navigation
function showTab(tabName) {
  // ซ่อนทุก tab content
  var tabContents = document.querySelectorAll('.tab-content');
  tabContents.forEach(function(content) {
    content.style.display = 'none';
  });
  
  // รีเซ็ตทุก tab button
  var tabButtons = document.querySelectorAll('.tab-button');
  tabButtons.forEach(function(button) {
    button.style.fontWeight = '500';
    button.style.color = '#6b7280';
    button.style.borderBottom = 'none';
  });
  
  // แสดง tab content ที่เลือก
  document.getElementById(tabName).style.display = 'block';
  
  // อัปเดต active tab button
  event.target.style.fontWeight = '600';
  event.target.style.color = '#0c5e28';
  event.target.style.borderBottom = '3px solid #0c5e28';
}

// JavaScript สำหรับ dropdown ยาง
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up tire dropdowns...');
    
    // ซ่อนแท็บอื่นๆ และแสดงเฉพาะแท็บ "ข้อมูลรถ" เมื่อโหลดหน้า
    var tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(function(content) {
        content.style.display = 'none';
    });
    
    // แสดงเฉพาะแท็บ "ข้อมูลรถ"
    var vehicleTab = document.getElementById('vehicle');
    if (vehicleTab) {
        vehicleTab.style.display = 'block';
    }
    
    // ตรวจสอบว่า elements มีอยู่หรือไม่
    const frontBrand = document.getElementById('tire_front_brand');
    const frontModel = document.getElementById('tire_front_model');
    const rearBrand = document.getElementById('tire_rear_brand');
    const rearModel = document.getElementById('tire_rear_model');
    
    console.log('Front brand element:', frontBrand);
    console.log('Front model element:', frontModel);
    console.log('Rear brand element:', rearBrand);
    console.log('Rear model element:', rearModel);
    
    // ตรวจสอบว่า elements มีอยู่ก่อนเพิ่ม event listeners
    if (!frontBrand || !frontModel || !rearBrand || !rearModel) {
        console.error('Some tire elements not found!');
        return;
    }
    
    // โหลดข้อมูลยางที่มีอยู่แล้ว
    function loadExistingTireData() {
        // Front tire
        if (frontBrand.value && frontBrand.value !== '') {
            console.log('Loading front tire models for brand ID:', frontBrand.value);
            fetch('/api/tire-models/' + frontBrand.value)
                .then(response => response.json())
                .then(models => {
                    console.log('Received front models:', models);
                    if (Array.isArray(models)) {
                        frontModel.innerHTML = '<option value="">-- เลือกรุ่น --</option>';
                        models.forEach(function(model) {
                            frontModel.innerHTML += `<option value="${model.model_id}">${model.model_name}</option>`;
                        });
                        // เลือกรุ่นยางที่มีอยู่แล้ว - ตรวจสอบจากข้อมูลในฟอร์ม
                        const existingModelId = '{{ tire_data.front_left.model_id if tire_data and tire_data.get("front_left") and tire_data.front_left.model_id else "" }}';
                        if (existingModelId && frontModel.querySelector('option[value="' + existingModelId + '"]')) {
                            frontModel.value = existingModelId;
                            console.log('Set front model to:', existingModelId);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading front tire models:', error);
                });
        }
        
        // Rear tire
        if (rearBrand.value && rearBrand.value !== '') {
            console.log('Loading rear tire models for brand ID:', rearBrand.value);
            fetch('/api/tire-models/' + rearBrand.value)
                .then(response => response.json())
                .then(models => {
                    console.log('Received rear models:', models);
                    if (Array.isArray(models)) {
                        rearModel.innerHTML = '<option value="">-- เลือกรุ่น --</option>';
                        models.forEach(function(model) {
                            rearModel.innerHTML += `<option value="${model.model_id}">${model.model_name}</option>`;
                        });
                        // เลือกรุ่นยางที่มีอยู่แล้ว - ตรวจสอบจากข้อมูลในฟอร์ม
                        const existingModelId = '{{ tire_data.rear_left.model_id if tire_data and tire_data.get("rear_left") and tire_data.rear_left.model_id else "" }}';
                        if (existingModelId && rearModel.querySelector('option[value="' + existingModelId + '"]')) {
                            rearModel.value = existingModelId;
                            console.log('Set rear model to:', existingModelId);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading rear tire models:', error);
                });
        }
    }
    
    // โหลดข้อมูลยางที่มีอยู่แล้วเมื่อโหลดหน้า
    setTimeout(function() {
        loadExistingTireData();
    }, 100);
    
    // Front tire brand change
    frontBrand.addEventListener('change', function() {
        var brandId = this.value;
        var modelSelect = document.getElementById('tire_front_model');
        console.log('Front tire brand changed to:', brandId);
        modelSelect.innerHTML = '<option value="">-- เลือกรุ่น --</option>';
        if (!brandId) return;
        
        console.log('Fetching tire models for brand ID:', brandId);
        fetch('/api/tire-models/' + brandId)
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(models => {
                console.log('Received models:', models);
                if (Array.isArray(models)) {
                    models.forEach(function(model) {
                        modelSelect.innerHTML += `<option value="${model.model_id}">${model.model_name}</option>`;
                    });
                } else {
                    console.error('Models is not an array:', models);
                }
            })
            .catch(error => {
                console.error('Error fetching tire models:', error);
            });
    });

    // Rear tire brand change
    rearBrand.addEventListener('change', function() {
        var brandId = this.value;
        var modelSelect = document.getElementById('tire_rear_model');
        console.log('Rear tire brand changed to:', brandId);
        modelSelect.innerHTML = '<option value="">-- เลือกรุ่น --</option>';
        if (!brandId) return;
        
        console.log('Fetching tire models for brand ID:', brandId);
        fetch('/api/tire-models/' + brandId)
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(models => {
                console.log('Received models:', models);
                if (Array.isArray(models)) {
                    models.forEach(function(model) {
                        modelSelect.innerHTML += `<option value="${model.model_id}">${model.model_name}</option>`;
                    });
                } else {
                    console.error('Models is not an array:', models);
                }
            })
            .catch(error => {
                console.error('Error fetching tire models:', error);
            });
    });

    // Vehicle brand change
    document.getElementById('brand_id').addEventListener('change', function() {
        var brandId = this.value;
        var modelSelect = document.getElementById('model_name');
        modelSelect.innerHTML = '<option value="">-- เลือกรุ่น --</option>';
        if (!brandId) return;
        
        fetch('/api/vehicle_models?brand_id=' + brandId)
            .then(response => response.json())
            .then(models => {
                models.forEach(function(model) {
                    modelSelect.innerHTML += `<option value="${model.car_model_name}">${model.car_model_name}</option>`;
                });
            });
    });

    // ===== COPY FRONT TO REAR FUNCTIONALITY =====
    const copyFrontToRearBtn = document.getElementById('copyFrontToRear');
    if (copyFrontToRearBtn) {
        copyFrontToRearBtn.addEventListener('click', function() {
            const frontSize = document.querySelector('input[name="tire_front_size"]');
            const frontBrand = document.querySelector('select[name="tire_front_brand_id"]');
            const frontModel = document.querySelector('select[name="tire_front_model_id"]');
            
            const rearSize = document.querySelector('input[name="tire_rear_size"]');
            const rearBrand = document.querySelector('select[name="tire_rear_brand_id"]');
            const rearModel = document.querySelector('select[name="tire_rear_model_id"]');
            
            if (frontSize && frontSize.value.trim()) {
                rearSize.value = frontSize.value;
            }
            
            if (frontBrand && frontBrand.value) {
                rearBrand.value = frontBrand.value;
                // Trigger change event to load models
                rearBrand.dispatchEvent(new Event('change'));
                
                // Set model after a short delay to allow models to load
                setTimeout(() => {
                    if (frontModel && frontModel.value) {
                        rearModel.value = frontModel.value;
                    }
                }, 100);
            }
            
            // Visual feedback
            const originalText = this.textContent;
            const originalClass = this.className;
            this.textContent = 'คัดลอกแล้ว!';
            this.className = originalClass.replace('text-blue-600', 'text-green-600').replace('border-blue-300', 'border-green-300');
            
            setTimeout(() => {
                this.textContent = originalText;
                this.className = originalClass;
            }, 1500);
        });
    }

    // ===== COPY DOT TO ALL FUNCTIONALITY =====
    const copyDotToAllBtn = document.getElementById('copyDotToAll');
    if (copyDotToAllBtn) {
        copyDotToAllBtn.addEventListener('click', function() {
            const frontLeftDot = document.querySelector('input[name="dot_front_left"]');
            const frontRightDot = document.querySelector('input[name="dot_front_right"]');
            const rearLeftDot = document.querySelector('input[name="dot_rear_left"]');
            const rearRightDot = document.querySelector('input[name="dot_rear_right"]');
            
            if (frontLeftDot && frontLeftDot.value.trim()) {
                const value = frontLeftDot.value.trim();
                frontRightDot.value = value;
                rearLeftDot.value = value;
                rearRightDot.value = value;
                
                // Visual feedback
                const originalText = this.textContent;
                const originalClass = this.className;
                this.textContent = 'คัดลอกแล้ว!';
                this.className = originalClass.replace('text-blue-600', 'text-green-600').replace('border-blue-300', 'border-green-300');
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.className = originalClass;
                }, 1500);
            } else {
                alert('กรุณากรอกข้อมูล DOT หน้าซ้ายก่อน');
            }
        });
    }

    // ===== SERVICE CHECKBOX FUNCTIONALITY =====
    // Function to disable/enable sub-checkboxes based on main service checkbox
    function toggleSubCheckboxes(serviceId, isChecked) {
        const subCheckboxes = document.querySelectorAll(`input[name="service_option_${serviceId}"]`);
        subCheckboxes.forEach(checkbox => {
            checkbox.disabled = !isChecked;
            if (!isChecked) {
                checkbox.checked = false;
            }
        });
    }

    // Initialize all service checkboxes
    const serviceCheckboxes = document.querySelectorAll('input[name="service_id"]');
    serviceCheckboxes.forEach(checkbox => {
        const serviceId = checkbox.value;
        const isChecked = checkbox.checked;
        
        // Set initial state
        toggleSubCheckboxes(serviceId, isChecked);
        
        // Add event listener for changes
        checkbox.addEventListener('change', function() {
            toggleSubCheckboxes(serviceId, this.checked);
        });
    });

    // ===== ADDRESS DROPDOWN FUNCTIONALITY =====
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const subdistrictSelect = document.getElementById('subdistrict');
    const zipcodeInput = document.getElementById('zipcode');
    
    // Province change event
    if (provinceSelect) {
        provinceSelect.addEventListener('change', function() {
            const province = this.value;
            
            // Clear district and subdistrict
            districtSelect.innerHTML = '<option value="">-- เลือกอำเภอ/เขต --</option>';
            subdistrictSelect.innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';
            zipcodeInput.value = '';
            
            if (!province) return;
            
            // Fetch districts for selected province
            fetch(`/api/districts?province=${encodeURIComponent(province)}`)
                .then(response => response.json())
                .then(districts => {
                    districts.forEach(function(district) {
                        districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching districts:', error);
                });
        });
    }
    
    // District change event
    if (districtSelect) {
        districtSelect.addEventListener('change', function() {
            const district = this.value;
            const province = provinceSelect.value;
            
            // Clear subdistrict and zipcode
            subdistrictSelect.innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';
            zipcodeInput.value = '';
            
            if (!district || !province) return;
            
            // Fetch subdistricts for selected district
            fetch(`/api/subdistricts?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}`)
                .then(response => response.json())
                .then(subdistricts => {
                    subdistricts.forEach(function(subdistrict) {
                        subdistrictSelect.innerHTML += `<option value="${subdistrict}">${subdistrict}</option>`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching subdistricts:', error);
                });
        });
    }
    
    // Subdistrict change event
    if (subdistrictSelect) {
        subdistrictSelect.addEventListener('change', function() {
            const subdistrict = this.value;
            const district = districtSelect.value;
            const province = provinceSelect.value;
            
            // Clear zipcode
            zipcodeInput.value = '';
            
            if (!subdistrict || !district || !province) return;
            
            // Fetch zipcode for selected subdistrict
            fetch(`/api/zipcodes?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}&subdistrict=${encodeURIComponent(subdistrict)}`)
                .then(response => response.json())
                .then(zipcodes => {
                    if (zipcodes.length > 0) {
                        zipcodeInput.value = zipcodes[0]; // Use first zipcode if multiple
                    }
                })
                .catch(error => {
                    console.error('Error fetching zipcodes:', error);
                });
        });
    }
});
</script>
{% endblock %}