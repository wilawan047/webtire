{% extends "staff/layout.html" %}

{% block title %}แก้ไขข้อมูลผู้ใช้ - TireWeb Staff{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-md">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-green-900">แก้ไขข้อมูลผู้ใช้</h2>
    </div>
</div>

<!-- Profile Form -->
<div class="max-w-2xl mx-auto px-6 md:px-12 lg:px-16 xl:px-20">
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 md:p-8 hover:shadow-xl transition-shadow duration-200">
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            <!-- CSRF Protection -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Avatar -->
            <div>
                <label class="block text-sm font-bold text-green-800 mb-4">
                    รูปโปรไฟล์
                </label>
                <div class="flex flex-col items-center space-y-4">
                    {% if user.avatar_filename %}
                        <img src="{{ url_for('static', filename='uploads/profile/' + user.avatar_filename) }}?v={{ range(1, 10000) | random }}"
                             alt="Profile Avatar"
                             class="w-32 h-32 rounded-full object-cover border-4 border-green-200 shadow-lg">
                    {% else %}
                        <div class="w-32 h-32 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white text-4xl font-bold shadow-lg">
                            {{ user.name[:1]|upper if user.name else 'U' }}
                        </div>
                    {% endif %}
                    <div class="text-center">
                        <label for="avatar" class="cursor-pointer inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-md hover:shadow-lg">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            แก้ไขภาพโปรไฟล์
                        </label>
                        <input type="file" 
                               id="avatar" 
                               name="avatar" 
                               accept="image/*"
                               class="hidden"
                               onchange="previewImage(this)">
                        <p class="text-xs text-gray-500 mt-2">รองรับไฟล์ JPG, PNG ขนาดไม่เกิน 5MB</p>
                    </div>
                </div>
            </div>

            <!-- Name -->
            <div>
                <label for="name" class="block text-sm font-bold text-green-800 mb-2">
                    ชื่อผู้ใช้
                </label>
                <input type="text" 
                       id="name" 
                       name="name" 
                       value="{{ user.name or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="กรอกชื่อผู้ใช้"
                       required>
            </div>

            <!-- Username (Read-only) -->
            <div>
                <label for="username" class="block text-sm font-bold text-green-800 mb-2">
                    ชื่อผู้ใช้ (Username)
                </label>
                <input type="text" 
                       id="username" 
                       value="{{ user.username or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                       readonly>
                <p class="text-sm text-gray-500 mt-1">ไม่สามารถแก้ไขชื่อผู้ใช้ได้</p>
            </div>

            <!-- Role (Read-only) -->
            <div>
                <label for="role" class="block text-sm font-bold text-green-800 mb-2">
                    บทบาท
                </label>
                <input type="text" 
                       id="role" 
                       value="พนักงาน"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                       readonly>
            </div>

            <!-- Created Date (Read-only) -->
            <div>
                <label for="created_at" class="block text-sm font-bold text-green-800 mb-2">
                    วันที่สร้างบัญชี
                </label>
                <input type="text" 
                       id="created_at" 
                       value="{{ user.created_at or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                       readonly>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{{ url_for('staff.dashboard') }}" 
                   class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ยกเลิก
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-md hover:shadow-lg">
                    บันทึกข้อมูล
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // หา element ที่แสดงรูปภาพ
                const avatarContainer = document.querySelector('.flex.flex-col.items-center.space-y-4');
                const existingImg = avatarContainer.querySelector('img');
                const existingDiv = avatarContainer.querySelector('div.w-32.h-32.rounded-full.bg-green-200');
                
                // สร้างรูปภาพใหม่
                const newImg = document.createElement('img');
                newImg.src = e.target.result;
                newImg.alt = 'Profile Avatar Preview';
                newImg.className = 'w-32 h-32 rounded-full object-cover border-4 border-gray-200 shadow-lg';
                
                // ลบรูปภาพเก่าหรือ div เก่า
                if (existingImg) {
                    existingImg.remove();
                }
                if (existingDiv) {
                    existingDiv.remove();
                }
                
                // เพิ่มรูปภาพใหม่
                avatarContainer.insertBefore(newImg, avatarContainer.firstChild);
            };
            
            reader.readAsDataURL(input.files[0]);
            
            // ส่งฟอร์มอัปโหลดรูปอัตโนมัติหลังจาก 1 วินาที
            setTimeout(() => {
                const form = document.querySelector('form');
                if (form) {
                    form.submit();
                }
            }, 1000);
        }
    }

    // อัปเดตภาพใหม่หลังอัปโหลด
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const avatarUpdated = urlParams.get('avatar_updated');
        const newFilename = urlParams.get('filename');
        const img = document.querySelector('.flex.flex-col.items-center.space-y-4 img');

        if (avatarUpdated === '1' && newFilename && img) {
            const newImageUrl = `/static/uploads/profile/${newFilename}?t=${new Date().getTime()}`;
            img.src = newImageUrl;
            history.replaceState({}, document.title, window.location.pathname);
        }
    });
</script>
{% endblock %}