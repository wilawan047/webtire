{% extends "staff/layout.html" %}
{% block title %}รายการจอง{% endblock %}
{% block content %}

  <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
    <h1 class="text-2xl font-bold text-green-900 w-full sm:w-auto text-center">{{ page_title }}</h1>
    <a href="{{ url_for('staff.add_booking') }}" class="bg-green-500 text-white px-4 py-2 rounded-xl shadow-md hover:bg-green-600 active:bg-green-700 font-semibold transition whitespace-nowrap">+ เพิ่มการจอง</a>
  </div>
  <!-- Search and Filter Form -->
  <form method="get" class="mb-6 flex flex-row items-center gap-2 flex-wrap justify-center">
    <!-- แก้ไข: ใช้ตัวแปร statuses ที่ส่งมาจาก app.py -->
    <select name="status" class="border border-green-500 p-2 rounded-md">
      <option value="">ทุกสถานะ</option>
      {% for status in statuses %}
        <option value="{{ status }}" {% if status_filter == status %}selected{% endif %}>{{ status }}</option>
      {% endfor %}
    </select>
    <input type="text" name="search" value="{{ search or '' }}" placeholder="ค้นหาลูกค้าหรือทะเบียนรถ..." class="border border-green-500 p-2 rounded-md w-64 focus:ring-2 focus:ring-green-400 focus:border-green-400">
    <button class="bg-green-500 text-white px-6 py-2 rounded-xl hover:bg-green-600 active:bg-green-700 transition font-semibold shadow-md flex items-center gap-2" type="submit">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      ค้นหา
    </button>
  </form>
  <div class="overflow-x-auto mb-8">
    <table class="min-w-full table-auto rounded-xl shadow-md overflow-hidden text-sm">
      <thead class="bg-[#e6f4ea]">
        <tr>
          <th class="px-4 py-2 text-center align-top">วันที่จอง</th>
          <th class="px-4 py-2 text-left align-top">ลูกค้า</th>
          <th class="px-4 py-2 text-left align-top">ทะเบียนรถ</th>
          <th class="px-4 py-2 text-center align-top">สถานะ</th>
          <th class="px-4 py-2"></th>
        </tr>
      </thead>
      <tbody>
        {% for b in bookings %}
        <tr class="{% if loop.index0 % 2 == 0 %}bg-white{% else %}bg-[#f0fdf4]{% endif %} hover:bg-green-50 transition border-b border-gray-300">
          <td class="px-4 py-2 text-center align-top">{{ b.booking_date|date_thai }}</td>
          <td class="px-4 py-2 text-left align-top">{{ '' if b.first_name in [None, '-', 'None'] else b.first_name }} {{ '' if b.last_name in [None, '-', 'None'] else b.last_name }}</td>
          <td class="px-4 py-2 text-left align-top">{{ '' if b.license_plate in [None, '-', 'None'] else b.license_plate }}{% if b.license_province %} <span class="text-gray-500">({{ b.license_province }})</span>{% endif %}</td>
          <!-- ส่วนที่แก้ไข: แสดงสถานะเป็นข้อความธรรมดา -->
          <td class="px-4 py-2 text-center align-top">
            <span class="whitespace-nowrap">{{ b.status }}</span>
          </td>
          <td class="px-4 py-2 text-center align-top whitespace-nowrap flex flex-row gap-2 justify-center">
            <a href="{{ url_for('staff.edit_booking', booking_id=b.booking_id) }}" class="inline-flex items-center px-3 py-1 bg-green-500 text-white rounded-xl shadow-md hover:bg-green-600 active:bg-green-700 font-semibold transition" title="แก้ไข">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M16.862 3.487a2.5 2.5 0 113.535 3.535L7.5 19.92l-4.243.707.707-4.243L16.862 3.487z"/><path d="M15 6l3 3" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
            </a>
            <button type="button" data-booking-id="{{ b.booking_id }}" class="delete-btn inline-flex items-center px-3 py-1 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 active:bg-red-700 font-semibold transition" title="ลบ">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 6h18" stroke-width="2" stroke-linecap="round"/><path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m2 0v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6h16z" stroke-width="2"/><path d="M10 11v6M14 11v6" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </td>
        </tr>
        {% endfor %}
        {% if bookings|length == 0 %}
        <tr><td colspan="5" class="text-center text-gray-500 py-4">ไม่พบการจอง</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
  <div class="bg-white rounded-2xl p-8 max-w-sm w-auto mx-4 shadow-2xl border-0 transform transition-all duration-300 scale-100">
    <div class="text-center">
      <!-- Icon -->
      <div class="mx-auto mb-4 w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      </div>
      
      <!-- Title -->
      <h3 class="text-xl font-semibold text-gray-900 mb-2">ยืนยันการลบ</h3>
      
      <!-- Message -->
      <p class="text-gray-600 mb-8 text-base leading-relaxed">คุณต้องการลบการจองนี้หรือไม่?</p>
      
      <!-- Buttons -->
      <div class="flex justify-center space-x-4">
        <button onclick="hideDeleteModal()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 hover:scale-105 transition-all duration-200 font-medium min-w-[80px] border border-gray-200">
          ยกเลิก
        </button>
        <button id="confirmDelete" class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 hover:scale-105 transition-all duration-200 font-medium min-w-[80px] shadow-lg">
          ตกลง
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let deleteBookingId = null;

function showDeleteModal(bookingId) {
    deleteBookingId = bookingId;
    
    // Show modal
    document.getElementById('deleteModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    deleteBookingId = null;
}

// Event delegation for delete buttons
document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-btn')) {
        const bookingId = e.target.closest('.delete-btn').getAttribute('data-booking-id');
        showDeleteModal(bookingId);
    }
});

// Event listeners
document.getElementById('cancelDelete').addEventListener('click', hideDeleteModal);

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (deleteBookingId) {
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/staff/bookings/${deleteBookingId}/delete`;
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
});

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideDeleteModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideDeleteModal();
    }
});
</script>

{% endblock %}